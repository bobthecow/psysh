language: php
os: linux

jobs:
    include:
        - php: 5.5.9
          env: 'BUILD_PHAR=0 COMPOSER_FLAGS="--prefer-lowest --prefer-stable"'
          dist: trusty
          name: PHP 5.5.9
        - php: 7.2
          env: 'BUILD_PHAR=1'
          dist: bionic
          name: Build Phar
        - php: hhvm-3.18
          dist: trusty
          name: HHVM 3.18
    allow_failures:
        - php: 5.5.9
          env: 'BUILD_PHAR=0 CCOMPOSER_FLAGS="--prefer-lowest --prefer-stable"'
    fast_finish: true

install:
    - travis_retry composer update --no-interaction $COMPOSER_FLAGS
    - |
      if [[ $BUILD_PHAR == 0 ]]; then
        composer bin phpunit update --no-interaction
      fi

script:
    - |
      if [[ $BUILD_PHAR == 0 ]]; then
        make test
      fi
    - |
      if [[ $BUILD_PHAR == 1 ]]; then
        make build -j 4
      fi

before_deploy: make dist -j 4

deploy:
    provider: releases
    token:
        secure: jMTc2z9JgpNJbf5Ia8uVMQRz2BYEqhr2IGZQtHoj3zgqt+SzgTdjFWK5yfSRdkiqt671JfSFU7Epc1NhURwMoQTlzLdCYnP9Lct9CFzHMTn0sNbDLDmZXkGuxe15DToMiaCexv8dBM2zb5QsdXpNeFunz+eqfeKqechuX6QXoaY=
    file_glob: true
    file: dist/psysh-*.tar.gz
    skip_cleanup: true
    on:
        tags: true
        repo: bobthecow/psysh
        condition: $BUILD_PHAR == 0
