name: Create release

on:
  push:
    tags: 'v*'

jobs:
  draft_release:
    name: 'Create draft release'
    runs-on: ubuntu-latest

    outputs:
      tag_name: ${{ steps.tag_name.outputs.tag }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}

    steps:
      - name: Get tag name
        id: tag_name
        uses: little-core-labs/get-git-tag@2c292ff564c1a61b989e29f0410d131317f89b03 # v3.0.2

      - name: Create draft release
        id: create_release
        uses: actions/create-release@0cb9c9b65d5d1901c1f53e5e66eaf4afd303e70e # v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: PsySH ${{ steps.tag_name.outputs.tag }}
          body: |
            New:
             - ...

            Improved:
             - ...

            Removed:
             - ...
          draft: true
          prerelease: false

  upload_assets:
    name: 'Upload release assets'
    needs: draft_release
    runs-on: ubuntu-latest

    strategy:
      matrix:
        package: ['', '-compat', '-php70', '-php70-compat']

    steps:
      - name: Check out code
        uses: actions/checkout@ec3a7ce113134d7a93b817d10a8272cb61118579 # v2
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@d37cc3048580de06099c81ded417530716a0d7ab # v2
        with:
          php-version: 7.4
          tools: composer:v2
          coverage: none

      - name: Install dependencies
        uses: nick-invision/retry@39da88d5f7d15a96aed861dbabbe8b7443e3182a # v1
        with:
          timeout_minutes: 5
          max_attempts: 5
          command: composer update --no-interaction --no-progress

      - name: Build release asset
        run: make dist/psysh-${{ needs.draft_release.outputs.tag_name }}${{ matrix.package }}.tar.gz

      - name: Upload release asset
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.draft_release.outputs.upload_url }}
          asset_path: ./dist/psysh-${{ needs.draft_release.outputs.tag_name }}${{ matrix.package }}.tar.gz
          asset_name: psysh-${{ needs.draft_release.outputs.tag_name }}${{ matrix.package }}.tar.gz
          asset_content_type: application/gzip
